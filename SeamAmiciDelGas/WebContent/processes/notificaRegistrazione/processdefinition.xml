<?xml version="1.0" encoding="UTF-8"?>

<process-definition  xmlns=""  name="notificaRegistrazione">


	<start-state name="RichiestaRegistrazione">
		<transition to="CreaEventoAziendaVisitare" name="inviaRegistrazione"></transition>
	</start-state>

	<task-node name="CreaEventoAziendaVisitare">
		<task name="crea_visita">
			<assignment pooled-actors="mediatore"></assignment>
		</task>
		<transition to="fork1" name="invia"></transition>
	</task-node>

	<task-node name="PartecipaVisita">
		<task name="partecipa_alla_visita" >
			<assignment pooled-actors="utenteGas"></assignment>
		</task>
		 <event type="timer-create">
      <action name="timerCreated" class="org.domain.SeamAmiciDelGas.processes.ChangeDueDateTimer">
        <timerName>varTimer</timerName>
      </action>
    </event>
		<event type="node-leave">
			<action name="SpegniTuttoeVaiAvanti" class="org.domain.SeamAmiciDelGas.processes.CancelTaskAction">
			 <taskName>partecipa_alla_visita</taskName>
			 </action>
		</event>
    <timer duedate="10 years" name="varTimer" transition="time-out"/>
		<transition to="AccettaAltriUtenti" name="partecipa"></transition>
		<transition to="join1" name="time-out"></transition>
	</task-node>

	<task-node name="VisualizzaQuestionari">
		<task name="visualizzaQuestionari">
			<assignment pooled-actors="admin"></assignment>
		</task>
		<transition to="AccettaRifiuta" name="decisioneAdmin"></transition>
	</task-node>

	<decision name="AccettaAltriUtenti">
		<transition to="PartecipaVisita" name="posti disponibili">
			<condition expression="#{!(postiOccupati &gt;= 10)}"></condition>
		</transition>
		<transition to="join1" name="posti esauriti">
			<condition expression="#{postiOccupati ==10}"></condition>
		</transition>
	</decision>
	
	<mail-node name="EmailConfermaRegistrazione">
		<transition to="ContadinoAccettato" name="ok"></transition>
	</mail-node>

	<fork name="fork1">
		<transition to="AccettaAltriUtenti"></transition>
		<transition to="join1" name="to EMAIL"></transition>
	</fork>

	<join name="join1">
		<transition to="AspettaDataQuestionario" name="aspettaData"></transition>
	</join>

	<process-state name="SubProcessNotifica">
		<sub-process name="notificaRequestReply" binding="late"/>
		<variable access="read" name="messageSubProcess" mapped-name="notifyMessageRequest"></variable>
		<variable access="read" name="inviato" mapped-name="nomeDestinatario"></variable>
		<variable access="read" name="dataTimer" mapped-name="dataTimer"></variable>
		<variable access="read" name="MediatoreCheManda" mapped-name="nomeMittente"></variable>
		<variable access="read" name="compilato" mapped-name="compilato"></variable>
		<transition to="CustomNodeJoin" name="fineSubProcess"></transition>
	</process-state>

	<node name="CustomNodeFork">
	<action class="org.domain.SeamAmiciDelGas.processes.ForEachForkActionHandler"/>
		<transition to="SubProcessNotifica" name="invocaSubProcess"></transition>
	</node>

	<join name="CustomNodeJoin" >
		<transition to="VisualizzaQuestionari" name="notificaAdmin"></transition>
	</join>

	<mail-node name="EmailRifiutoRegistrazione">
		<transition to="ContadinoRifiutato" name="emailOk"></transition>
	</mail-node>

	<state name="AspettaDataQuestionario">
		<event type="timer-create">
      		<action name="timerState" class="org.domain.SeamAmiciDelGas.processes.TimerHandler">
        		<timerName>timerVarQuestionario</timerName>
      		</action>
    	</event>
    	<timer duedate="10 years" name="timerVarQuestionario" transition="notificaQuestionario"/>
		<transition to="CustomNodeFork" name="notificaQuestionario"></transition>
	</state>

	<decision name="AccettaRifiuta">
		<transition to="EmailConfermaRegistrazione" name="accetta">
			<condition expression="#{decisione == 1}"></condition>
		</transition>
		<transition to="EmailRifiutoRegistrazione" name="rifiuta">
			<condition expression="#{decisione == 0}"></condition>
		</transition>
	</decision>
	
	<end-state name="ContadinoAccettato"></end-state>
	
	<end-state name="ContadinoRifiutato"></end-state>

</process-definition>